# Helm-Based Deployment and APIM Automation

## Overview

This project implements a standardized, low-touch deployment mechanism using **Helm** for Kubernetes workloads and **Azure API Management (APIM)** for API exposure. The goal was to minimize developer effort, centralize configuration, and fully automate deployments through the release pipeline.

---

## Helm-Based Deployment

### Helm Chart Design

* A reusable Helm chart was developed to handle:

  * Application deployment
  * Service creation
  * VirtualService configuration
* Developers are required to provide **only minimal values** in the `values.yaml` file located under the `manifestv2` folder.
* All other configurations are handled internally by the Helm chart.
* The VirtualService automatically connects to the **default internal backend service**.

> At this stage, all required repository changes were completed.

---

## Repository and Azure Pipeline Changes

### Azure Pipeline Configuration

As part of the repository changes, Azure Pipeline steps were added to dynamically update deployment configurations during the build/release process.

#### AppSettings Replacement

* A pipeline script replaces placeholders in the Helm values file with environment-specific values sourced from Azure Pipeline variables.
* This ensures that no hardcoded values exist in the repository.

**Pipeline Step:**

* **displayName:** Replacing the Appsettings Files with Azure Config Store Details
* **Actions performed:**

  * Replace `acrregistry` placeholder with the value of `$(acrregistry)`
  * Replace `imagetag` placeholder with a dynamically generated tag using environment name and build ID

#### Artifact Publishing

* After updating the `values.yml`, the `manifestsV2` folder is published as a pipeline artifact.
* This artifact is later consumed during the release stage for Helm deployment.

---

## Release Pipeline Flow

### Tool Installation

During the release stage, the pipeline performs the following steps:

1. Install `kubelogin`
2. Install `kubectl`
3. Install `helm`

### Helm Authentication and Deployment

* Helm is authenticated against **Azure Container Registry (ACR)** to pull the Helm chart.
* Once authenticated, the deployment is executed using the `helm install` command.

---

## APIM Deployment Automation

After the Kubernetes deployment, APIM configuration is handled through automated tasks.

### PowerShell Script Execution

* Three PowerShell scripts were uploaded to **Azure Blob Storage**.
* During pipeline execution, these scripts are dynamically pulled and executed.

The scripts perform the following actions:

1. **Product Validation and Creation**

   * Checks whether required APIM products exist.
   * Creates products if they are missing.

2. **API Create/Update**

   * Creates or updates the API in APIM using a Swagger (OpenAPI) specification.

3. **Policy Update**

   * Applies or updates APIM policies for the deployed API.

---

## Configuration Management

* All release pipeline tasks are fully **parameterized using variables**.
* No task-level changes are required between environments.
* Environment-specific behavior is controlled entirely through variable values.

---

## Outcome

* Simplified developer onboarding with minimal configuration requirements.
* Fully automated, repeatable deployments for both Kubernetes and APIM.
* Clean separation of concerns between application deployment and API management.
